<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Windows SSH &mdash; Ansible Community Documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=5707b69d" />
      <link rel="stylesheet" type="text/css" href="../_static/css/ansible.css?v=c5b67dd2" />
      <link rel="stylesheet" type="text/css" href="../_static/antsibull-minimal.css" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/css/rtd-ethical-ads.css?v=289b023e" />

  
    <link rel="shortcut icon" href="../_static/images/Ansible-Mark-RGB_Black.png"/>
    <link rel="canonical" href="https://docs.ansible.com/ansible/latest/os_guide/windows_ssh.html"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=c7b8e248"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Using Ansible and Windows" href="windows_usage.html" />
    <link rel="prev" title="Windows performance" href="windows_performance.html" /><!-- extra head elements for Ansible beyond RTD Sphinx Theme -->
<script src="https://www.redhat.com/dtm.js"></script>


<!-- <meta class="swiftype" name="published_at" data-type="date" content="2017-12-13" /> -->
<meta class="swiftype" name="version" data-type="string" content="devel">

<!-- Google Tag Manager Data Layer -->
<script>
 dataLayer = [];
</script>
<!-- End Google Tag Manager Data Layer -->



<script>
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','https://s.swiftypecdn.com/install/v2/st.js','_st');

_st('install','yABGvz2N8PwcwBxyfzUc','2.0.0');
</script>

</head>

<body class="wy-body-for-nav"><!-- extra body elements for Ansible beyond RTD Sphinx Theme -->
<!-- Google Tag Manager -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PSB293" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-PSB293');</script>
<!-- End Google Tag Manager -->

<div class="DocSite-globalNav ansibleNav">
  <ul>
    <li><a href="https://www.ansible.com/blog" target="_blank">Blog</a></li>
    <li><a href="https://forum.ansible.com/" target="_blank">Ansible community forum</a></li>
    <li><a href="https://docs.ansible.com/" target="_blank">Documentation</a></li>
  </ul>
</div>

<a class="DocSite-nav" href="/" style="padding-bottom: 30px;">

  <img class="DocSiteNav-logo"
    src="../_static/images/Ansible-Mark-RGB_White.png"
    alt="Ansible Logo">
  <div class="DocSiteNav-title">Ansible Community Documentation</div>
</a>
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Ansible
          </a>
              <div class="version">
                devel
              </div><!--- Based on https://github.com/rtfd/sphinx_rtd_theme/pull/438/files -->

<div class="version">
  
    <form class="version-dropdown" method="get">
      <script>
        function switchVersionTo(slug) {
          var current_url_path = window.location.pathname;
          var url_version = current_url_path.search("/devel/") > -1
            ? "/devel/"
            : "/latest/";
          var new_version_url = current_url_path.replace(url_version, "/" + slug + "/");
          window.location.replace(new_version_url);
        }
      </script>
      <label class="sr-only" for="version-list">Select version:</label>
      <select
          class="version-list"
          id="version-list"
          onchange="switchVersionTo(this.value);"
      >
        
        <option
            value="latest"
            
        >
            latest
        </option>
        
        <option
            value="9"
            
        >
            9
        </option>
        
        <option
            value="2.9"
            
        >
            2.9
        </option>
        
        <option
            value="devel"
            selected="selected"
        >
            devel
        </option>
        
      </select>
    </form>
  
</div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" method="get">
    <label class="sr-only" for="q">Search docs:</label>
    <input type="text" class="st-default-search-input" id="q" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
  
              <p class="caption" role="heading"><span class="caption-text">Ansible getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/index.html">Getting started with Ansible</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started_ee/index.html">Getting started with Execution Environments</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Installation, Upgrade &amp; Configuration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation_guide/index.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../porting_guides/porting_guides.html">Ansible Porting Guides</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using Ansible</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../inventory_guide/index.html">Building Ansible inventories</a></li>
<li class="toctree-l1"><a class="reference internal" href="../command_guide/index.html">Using Ansible command line tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../playbook_guide/index.html">Using Ansible playbooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vault_guide/index.html">Protecting sensitive data with Ansible vault</a></li>
<li class="toctree-l1"><a class="reference internal" href="../module_plugin_guide/index.html">Using Ansible modules and plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../collections_guide/index.html">Using Ansible collections</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Using Ansible on Windows and BSD</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro_bsd.html">Managing BSD hosts with Ansible</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="intro_windows.html">Managing Windows hosts with Ansible</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="windows_dsc.html">Desired State Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="windows_performance.html">Windows performance</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Windows SSH</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ssh-setup">SSH Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ansible-configuration">Ansible Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ssh-authentication">SSH Authentication</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="windows_usage.html">Using Ansible and Windows</a></li>
<li class="toctree-l3"><a class="reference internal" href="windows_winrm.html">Windows Remote Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="windows_winrm_certificate.html">WinRM Certificate Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="windows_winrm_kerberos.html">Kerberos Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="intro_windows.html#bootstrapping-windows">Bootstrapping Windows</a></li>
<li class="toctree-l3"><a class="reference internal" href="intro_windows.html#connecting-to-windows-nodes">Connecting to Windows nodes</a></li>
<li class="toctree-l3"><a class="reference internal" href="intro_windows.html#which-modules-are-available">Which modules are available?</a></li>
<li class="toctree-l3"><a class="reference internal" href="intro_windows.html#using-windows-as-the-control-node">Using Windows as the control node</a></li>
<li class="toctree-l3"><a class="reference internal" href="intro_windows.html#windows-facts">Windows facts</a></li>
<li class="toctree-l3"><a class="reference internal" href="intro_windows.html#common-windows-problems">Common Windows problems</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tips_tricks/index.html">Ansible tips and tricks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing to Ansible</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../community/index.html">Ansible Community Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community/contributions_collections.html">Ansible Collections Contributor Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community/contributions.html">ansible-core Contributors Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community/advanced_index.html">Advanced Contributor Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide/style_guide/index.html">Ansible documentation style guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Extending Ansible</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide/index.html">Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Common Ansible Scenarios</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scenario_guides/cloud_guides.html">Legacy Public Cloud Guides</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Network Automation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../network/getting_started/index.html">Network Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/user_guide/index.html">Network Advanced Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/dev_guide/index.html">Network Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Ansible Galaxy</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../galaxy/user_guide.html">Galaxy User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../galaxy/dev_guide.html">Galaxy Developer Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference &amp; Appendices</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../collections/index.html">Collection Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../collections/all_plugins.html">Indexes of all modules and plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/playbooks_keywords.html">Playbook Keywords</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/common_return_values.html">Return Values</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/config.html">Ansible Configuration Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/general_precedence.html">Controlling how Ansible behaves: precedence rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/YAMLSyntax.html">YAML Syntax</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/python_3_support.html">Python 3 Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/interpreter_discovery.html">Interpreter Discovery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/release_and_maintenance.html">Releases and maintenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/test_strategies.html">Testing Strategies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide/testing/sanity/index.html">Sanity Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/module_utils.html">Ansible Reference: Module Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/special_variables.html">Special Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/tower.html">Red Hat Ansible Automation Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/automationhub.html">Ansible Automation Hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/logging.html">Logging Ansible output</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Roadmaps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../roadmap/ansible_roadmap_index.html">Ansible Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap/ansible_core_roadmap_index.html">ansible-core Roadmaps</a></li>
</ul>
<!-- extra nav elements for Ansible beyond RTD Sphinx Theme -->
<!-- changeable widget links to tower - do not change as image controlled by Ansible-->
<div id="sideBanner">
  <br/>
  <a href="https://www.ansible.com/docs-left?utm_source=docs">
    <img style="border-width:0px;" src="https://cdn2.hubspot.net/hubfs/330046/docs-graphics/ASB-docs-left-rail.png" />
  </a>
  <br/><br/><br/>
</div>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Ansible</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Using Ansible on Windows and BSD</a></li>
          <li class="breadcrumb-item"><a href="intro_windows.html">Managing Windows hosts with Ansible</a></li>
      <li class="breadcrumb-item active">Windows SSH</li>
  <li class="wy-breadcrumbs-aside">
            <!-- Remove main index page as it is no longer editable -->
            
              <a href="https://github.com/ansible/ansible-documentation/edit/devel/docs/docsite/rst/os_guide/windows_ssh.rst?description=%23%23%23%23%23%20SUMMARY%0A%3C!---%20Your%20description%20here%20--%3E%0A%0A%0A%23%23%23%23%23%20ISSUE%20TYPE%0A-%20Docs%20Pull%20Request%0A%0A%2Blabel:%20docsite_pr" class="fa fa-github"> Edit on GitHub</a>
            
  </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
  <script>
    function startsWith(str, needle) {
      return str.slice(0, needle.length) == needle
    }
    function startsWithOneOf(str, needles) {
      return needles.some(function (needle) {
        return startsWith(str, needle);
      });
    }
    var banner = '';
      var extra_banner = '';
    /*use extra_banner for when we want something extra, like a survey or Community Day notice */
   /*  var extra_banner =
      '<div id="latest_extra_banner_id" class="admonition important">' +
        '<p style="padding-bottom: 1.2rem;">' +
        'Discuss Ansible in the new <a href="https://forum.ansible.com/t/welcome-to-the-ansible-community/5">Ansible Forum!</a>' +
        '</p>' +
      '</div>';
      */
    // Create a banner if we're not on the official docs site
    if (location.host == "docs.testing.ansible.com") {
      document.write('<div id="testing_banner_id" class="admonition important">' +
                     '<p>This is the testing site for Ansible Documentation. Unless you are reviewing pre-production changes, please visit the <a href="https://docs.ansible.com/ansible/latest/">official documentation website</a>.</p> <p></p>' +
                     '</div>');
    }
    
      // Create a banner
      current_url_path = window.location.pathname;

      var important = false;
      var msg = '<p>';
      if (startsWith(current_url_path, "/ansible-core/")) {
        msg += 'You are reading documentation for Ansible Core, which contains no plugins except for those in ansible.builtin. For documentation of the Ansible package, go to <a href="/ansible/latest">the latest documentation</a>.';
      } else if (startsWithOneOf(current_url_path, ["/ansible/latest/", "/ansible/10/"])) {
        /* temp extra banner to advertise something */
        banner += extra_banner;

        msg += 'This is the <b>latest</b> (stable) Ansible community documentation. For Red Hat Ansible Automation Platform subscriptions, see <a href="https://access.redhat.com/support/policy/updates/ansible-automation-platform">Life Cycle</a> for version details.';
      } else if (startsWith(current_url_path, "/ansible/2.9/")) {
        msg += 'You are reading the latest Red Hat released version of the Ansible documentation. Community users can use this version, or select <b>latest</b> from the version selector to the left for the most recent community version.';
      } else if (startsWith(current_url_path, "/ansible/devel/")) {
        /* temp extra banner to advertise something */
        banner += extra_banner;

        msg += 'You are reading the <b>devel</b> version of the Ansible documentation - this version is not guaranteed stable. Use the version selection to the left if you want the <b>latest</b> (stable) released version.';
      } else {
        msg += 'You are reading an older version of the Ansible documentation. Use the version selection to the left if you want the <b>latest</b> (stable) released version.';
        /* temp extra banner to advertise something - this is for testing*/
        banner += extra_banner;

      }
      msg += '</p>';

      banner += '<div id="banner_id" class="admonition ';
      banner += important ? 'important' : 'caution';
      banner += '">';
      banner += important ? '<br>' : '';
      banner += msg;
      banner += important ? '<br>' : '';
      banner += '</div>';
      document.write(banner);
    
  </script>


  
           <div itemprop="articleBody">
             
  <section id="windows-ssh">
<span id="id1"></span><h1>Windows SSH<a class="headerlink" href="#windows-ssh" title="Link to this heading"></a></h1>
<p>On newer Windows versions, you can use SSH to connect to a Windows host. This is an alternative connection option to <a class="reference internal" href="windows_winrm.html#windows-winrm"><span class="std std-ref">WinRM</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While Ansible could use the SSH connection plugin with Windows nodes since Ansible 2.8, official support was only added in version 2.18.</p>
</div>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#ssh-setup" id="id2">SSH Setup</a></p>
<ul>
<li><p><a class="reference internal" href="#default-shell-configuration" id="id3">Default Shell Configuration</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#ansible-configuration" id="id4">Ansible Configuration</a></p></li>
<li><p><a class="reference internal" href="#ssh-authentication" id="id5">SSH Authentication</a></p>
<ul>
<li><p><a class="reference internal" href="#key-authentication" id="id6">Key Authentication</a></p></li>
<li><p><a class="reference internal" href="#gssapi-authentication" id="id7">GSSAPI Authentication</a></p></li>
<li><p><a class="reference internal" href="#password-authentication" id="id8">Password Authentication</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="ssh-setup">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">SSH Setup</a><a class="headerlink" href="#ssh-setup" title="Link to this heading"></a></h2>
<p>Microsoft provides an OpenSSH implementation with Windows since Windows Server 2019 as a Windows capability. It can also be installed through an upstream package under <a class="reference external" href="https://github.com/PowerShell/Win32-OpenSSH">Win32-OpenSSH</a>. Ansible officially only supports the OpenSSH implementation shipped with Windows, not the upstream package. The OpenSSH version must be version <code class="docutils literal notranslate"><span class="pre">7.9.0.0</span></code> at a minimum. This effectively means official support starts with Windows Server 2022 because Server 2019 ships with version <code class="docutils literal notranslate"><span class="pre">7.7.2.1</span></code>. Using older Windows versions or the upstream package might work but is not supported.</p>
<p>To install the OpenSSH feature on Windows Server 2022 and later, use the following PowerShell command:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="nb">Get-WindowsCapability</span> <span class="n">-Name</span> <span class="n">OpenSSH</span><span class="p">.</span><span class="n">Server</span><span class="p">*</span> <span class="n">-Online</span> <span class="p">|</span>
    <span class="nb">Add-WindowsCapability</span> <span class="n">-Online</span>
<span class="nb">Set-Service</span> <span class="n">-Name</span> <span class="n">sshd</span> <span class="n">-StartupType</span> <span class="n">Automatic</span> <span class="n">-Status</span> <span class="n">Running</span>

<span class="nv">$firewallParams</span> <span class="p">=</span> <span class="p">@{</span>
    <span class="n">Name</span>        <span class="p">=</span> <span class="s1">&#39;sshd-Server-In-TCP&#39;</span>
    <span class="n">DisplayName</span> <span class="p">=</span> <span class="s1">&#39;Inbound rule for OpenSSH Server (sshd) on TCP port 22&#39;</span>
    <span class="n">Action</span>      <span class="p">=</span> <span class="s1">&#39;Allow&#39;</span>
    <span class="n">Direction</span>   <span class="p">=</span> <span class="s1">&#39;Inbound&#39;</span>
    <span class="n">Enabled</span>     <span class="p">=</span> <span class="s1">&#39;True&#39;</span>  <span class="c"># This is not a boolean but an enum</span>
    <span class="n">Profile</span>     <span class="p">=</span> <span class="s1">&#39;Any&#39;</span>
    <span class="n">Protocol</span>    <span class="p">=</span> <span class="s1">&#39;TCP&#39;</span>
    <span class="n">LocalPort</span>   <span class="p">=</span> <span class="n">22</span>
<span class="p">}</span>
<span class="nb">New-NetFirewallRule</span> <span class="nv">@firewallParams</span>

<span class="nv">$shellParams</span> <span class="p">=</span> <span class="p">@{</span>
    <span class="n">Path</span>         <span class="p">=</span> <span class="s1">&#39;HKLM:\SOFTWARE\OpenSSH&#39;</span>
    <span class="n">Name</span>         <span class="p">=</span> <span class="s1">&#39;DefaultShell&#39;</span>
    <span class="n">Value</span>        <span class="p">=</span> <span class="s1">&#39;C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe&#39;</span>
    <span class="n">PropertyType</span> <span class="p">=</span> <span class="s1">&#39;String&#39;</span>
    <span class="n">Force</span>        <span class="p">=</span> <span class="nv">$true</span>
<span class="p">}</span>
<span class="nb">New-ItemProperty</span> <span class="nv">@shellParams</span>
</pre></div>
</div>
<section id="default-shell-configuration">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">Default Shell Configuration</a><a class="headerlink" href="#default-shell-configuration" title="Link to this heading"></a></h3>
<p>By default, OpenSSH on Windows uses <code class="docutils literal notranslate"><span class="pre">cmd.exe</span></code> as the default shell. While Ansible can work with this default shell it is recommended to change this to <code class="docutils literal notranslate"><span class="pre">powershell.exe</span></code> as it is better tested and should be faster than having <code class="docutils literal notranslate"><span class="pre">cmd.exe</span></code> as the default. To change the default shell you can use the following PowerShell script:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="c"># Set default to powershell.exe</span>
<span class="nv">$shellParams</span> <span class="p">=</span> <span class="p">@{</span>
    <span class="n">Path</span>         <span class="p">=</span> <span class="s1">&#39;HKLM:\SOFTWARE\OpenSSH&#39;</span>
    <span class="n">Name</span>         <span class="p">=</span> <span class="s1">&#39;DefaultShell&#39;</span>
    <span class="n">Value</span>        <span class="p">=</span> <span class="s1">&#39;C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe&#39;</span>
    <span class="n">PropertyType</span> <span class="p">=</span> <span class="s1">&#39;String&#39;</span>
    <span class="n">Force</span>        <span class="p">=</span> <span class="nv">$true</span>
<span class="p">}</span>
<span class="nb">New-ItemProperty</span> <span class="nv">@shellParams</span>

<span class="c"># Set default back to cmd.exe</span>
<span class="nb">Remove-ItemProperty</span> <span class="n">-Path</span> <span class="n">HKLM</span><span class="p">:\</span><span class="n">SOFTWARE</span><span class="p">\</span><span class="n">OpenSSH</span> <span class="n">-Name</span> <span class="n">DefaultShell</span>
</pre></div>
</div>
<p>The new default shell setting will apply to the next SSH connection, there is no need to restart the <code class="docutils literal notranslate"><span class="pre">sshd</span></code> service. You can also use Ansible to configure the default shell:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">set the default shell to PowerShell</span>
<span class="w">  </span><span class="nt">ansible.windows.win_regedit</span><span class="p">:</span>
<span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HKLM:\SOFTWARE\OpenSSH</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DefaultShell</span>
<span class="w">    </span><span class="nt">data</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reset SSH connection after shell change</span>
<span class="w">  </span><span class="nt">ansible.builtin.meta</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reset_connection</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">set the default shell to cmd</span>
<span class="w">  </span><span class="nt">ansible.windows.win_regedit</span><span class="p">:</span>
<span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HKLM:\SOFTWARE\OpenSSH</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DefaultShell</span>
<span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">absent</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reset SSH connection after shell change</span>
<span class="w">  </span><span class="nt">ansible.builtin.meta</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reset_connection</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">meta:</span> <span class="pre">reset_connection</span></code> is important to ensure the subsequent tasks will use the new default shell.</p>
</section>
</section>
<section id="ansible-configuration">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Ansible Configuration</a><a class="headerlink" href="#ansible-configuration" title="Link to this heading"></a></h2>
<p>To configure Ansible to use SSH for Windows hosts, you must set two connection variables:</p>
<ul class="simple">
<li><p>set <code class="docutils literal notranslate"><span class="pre">ansible_connection</span></code> to <code class="docutils literal notranslate"><span class="pre">ssh</span></code></p></li>
<li><p>set <code class="docutils literal notranslate"><span class="pre">ansible_shell_type</span></code> to <code class="docutils literal notranslate"><span class="pre">powershell</span></code> or <code class="docutils literal notranslate"><span class="pre">cmd</span></code></p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">ansible_shell_type</span></code> variable should reflect the <code class="docutils literal notranslate"><span class="pre">DefaultShell</span></code> configured on the Windows host. Other SSH options as documented under the <a class="reference internal" href="../collections/ansible/builtin/ssh_connection.html#ssh-connection"><span class="std std-ref">ssh</span></a> can also be set for the Windows host.</p>
</section>
<section id="ssh-authentication">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">SSH Authentication</a><a class="headerlink" href="#ssh-authentication" title="Link to this heading"></a></h2>
<p>Win32-OpenSSH authentication with Windows is similar to SSH authentication on Unix/Linux hosts. While there are many authentication methods that can be used there are typically three used on Windows:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Option</p></th>
<th class="head"><p>Local Accounts</p></th>
<th class="head"><p>Active Directory Accounts</p></th>
<th class="head"><p>Credential Delegation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Key</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p>GSSAPI</p></td>
<td><p>No</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-even"><td><p>Password</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
</tr>
</tbody>
</table>
<p>In most cases it is recommended to use key or GSSAPI authentication over password authentication.</p>
<section id="key-authentication">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Key Authentication</a><a class="headerlink" href="#key-authentication" title="Link to this heading"></a></h3>
<p>SSH key authentication on Windows works in the same way as SSH key authentication for POSIX nodes. You can generate a key pair using the <code class="docutils literal notranslate"><span class="pre">ssh-keygen</span></code> command and add the public key to the <code class="docutils literal notranslate"><span class="pre">authorized_keys</span></code> file in the user’s profile directory. The private key should be kept secure and not shared.</p>
<p>One difference is that the <code class="docutils literal notranslate"><span class="pre">authorized_keys</span></code> file for admin users is not located in the <code class="docutils literal notranslate"><span class="pre">.ssh</span></code> folder in the user’s profile directory but in <code class="docutils literal notranslate"><span class="pre">C:\ProgramData\ssh\administrators_authorized_keys</span></code>. It is possible to change the location of the <code class="docutils literal notranslate"><span class="pre">authorized_keys</span></code> file for admin users back to the user profile directory by removing, or commenting, the lines in <code class="docutils literal notranslate"><span class="pre">C:\ProgramData\ssh\sshd_config</span></code> and restarting the <code class="docutils literal notranslate"><span class="pre">sshd</span></code> service.</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">Match Group administrators</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">AuthorizedKeysFile __PROGRAMDATA__/ssh/administrators_authorized_keys</span>
</pre></div>
</div>
<p>SSH keys work with both local and domain accounts but suffer from the double-hop issue. This means that when using SSH key authentication with Ansible, the remote session will not have access to user credentials and will fail when attempting to access a network resource. To work around this problem, you can use <a class="reference internal" href="../playbook_guide/playbooks_privilege_escalation.html#become"><span class="std std-ref">become</span></a> on the task with the credentials of the user that needs access to the remote resource.</p>
</section>
<section id="gssapi-authentication">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">GSSAPI Authentication</a><a class="headerlink" href="#gssapi-authentication" title="Link to this heading"></a></h3>
<p>GSSAPI authentication will use Kerberos to authenticate the user with the Windows host. To use GSSAPI authentication with Ansible, the Windows server must be configured to allow GSSAPI authentication by editing the <code class="docutils literal notranslate"><span class="pre">C:\ProgramData\ssh\sshd_config</span></code> file. Either add in the following line or edit the existing line:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>GSSAPIAuthentication yes
</pre></div>
</div>
<p>Once edited restart the <code class="docutils literal notranslate"><span class="pre">sshd</span></code> service with <code class="docutils literal notranslate"><span class="pre">Restart-Service</span> <span class="pre">-Name</span> <span class="pre">sshd</span></code>.</p>
<p>On the Ansible control node, you need to have Kerberos installed and configured with the domain the Windows host is a member of. How to set this up and configure is outside the scope of this document. Once the Kerberos realm is configured you can use the <code class="docutils literal notranslate"><span class="pre">kinit</span></code> command to get a ticket for the user you are connecting with and <code class="docutils literal notranslate"><span class="pre">klist</span></code> to verify what tickets are available:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt;<span class="w"> </span>kinit<span class="w"> </span>username@REALM.COM
Password<span class="w"> </span><span class="k">for</span><span class="w"> </span>username@REALM.COM

&gt;<span class="w"> </span>klist
Ticket<span class="w"> </span>cache:<span class="w"> </span>KCM:1000
Default<span class="w"> </span>principal:<span class="w"> </span>username@REALM.COM

Valid<span class="w"> </span>starting<span class="w">     </span>Expires<span class="w">            </span>Service<span class="w"> </span>principal
<span class="m">29</span>/08/24<span class="w"> </span><span class="m">13</span>:54:51<span class="w">  </span><span class="m">29</span>/08/24<span class="w"> </span><span class="m">23</span>:54:51<span class="w">  </span>krbtgt/REALM.COM@REALM.COM
<span class="w">        </span>renew<span class="w"> </span><span class="k">until</span><span class="w"> </span><span class="m">05</span>/09/24<span class="w"> </span><span class="m">13</span>:54:48
</pre></div>
</div>
<p>Once you have a valid ticket you can use the <code class="docutils literal notranslate"><span class="pre">ansible_user</span></code> hostvar to specify the UPN username and Ansible will automatically use the Kerberos ticket for that user when using SSH.</p>
<p>It is also possible to enable unconstrained delegation through GSSAPI authentication to have the Windows node access network resources. For GSSAPI delegation to work the ticket retrieved by <code class="docutils literal notranslate"><span class="pre">kinit</span></code> must be forwardable and <code class="docutils literal notranslate"><span class="pre">ssh</span></code> must be called with the <code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">GSSAPIDelegateCredentials=yes</span></code> option. To retrieve a forwardable ticket either use the <code class="docutils literal notranslate"><span class="pre">-f</span></code> flag with <code class="docutils literal notranslate"><span class="pre">kinit</span></code> or add <code class="docutils literal notranslate"><span class="pre">forwardable</span> <span class="pre">=</span> <span class="pre">true</span></code> under <code class="docutils literal notranslate"><span class="pre">[libdefaults]</span></code> in the <code class="docutils literal notranslate"><span class="pre">/etc/krb5.conf</span></code> file.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt;<span class="w"> </span>kinit<span class="w"> </span>-f<span class="w"> </span>username@REALM.COM
Password<span class="w"> </span><span class="k">for</span><span class="w"> </span>username@REALM.COM

<span class="c1"># -f will show the ticket flags, we want to see F</span>
&gt;<span class="w"> </span>klist<span class="w"> </span>-f
Ticket<span class="w"> </span>cache:<span class="w"> </span>KCM:1000
Default<span class="w"> </span>principal:<span class="w"> </span>username@REALM.COM

Valid<span class="w"> </span>starting<span class="w">     </span>Expires<span class="w">            </span>Service<span class="w"> </span>principal
<span class="m">29</span>/08/24<span class="w"> </span><span class="m">13</span>:54:51<span class="w">  </span><span class="m">29</span>/08/24<span class="w"> </span><span class="m">23</span>:54:51<span class="w">  </span>krbtgt/REALM.COM@REALM.COM
<span class="w">        </span>renew<span class="w"> </span><span class="k">until</span><span class="w"> </span><span class="m">05</span>/09/24<span class="w"> </span><span class="m">13</span>:54:48,<span class="w"> </span>Flags:<span class="w"> </span>FRIA
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">GSSAPIDelegateCredentials=yes</span></code> option can either be set in the <code class="docutils literal notranslate"><span class="pre">~/.ssh/config</span></code> file or as a hostvar variable in the inventory:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="nt">ansible_ssh_common_args</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-o GSSAPIDelegateCredentials=yes</span>
</pre></div>
</div>
<p>Unlike the <code class="docutils literal notranslate"><span class="pre">psrp</span></code> or <code class="docutils literal notranslate"><span class="pre">winrm</span></code> connection plugins, the SSH connection plugin cannot get a Kerberos TGT ticket when provided with an explicit username and password. This means that the user must have a valid Kerberos ticket before running the playbook.</p>
<p>See <a class="reference internal" href="windows_winrm_kerberos.html#windows-winrm-kerberos"><span class="std std-ref">Kerberos Authentication</span></a> for more information on how to configure, use, and troubleshoot Kerberos authentication.</p>
</section>
<section id="password-authentication">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Password Authentication</a><a class="headerlink" href="#password-authentication" title="Link to this heading"></a></h3>
<p>Password authentication is the least secure method of authentication and is not recommended. However, it is possible to use password authentication with Windows SSH. To use password authentication with Ansible, set the <code class="docutils literal notranslate"><span class="pre">ansible_password</span></code> variable in the inventory file or in the playbook. Using password authentication requires the <code class="docutils literal notranslate"><span class="pre">sshpass</span></code> package to be installed on the Ansible control node.</p>
<p>Password authentication works like WinRM CredSSP authentication where the username and password is given to the Windows host and it will perform unconstrained delegation to access network resources.</p>
</section>
</section>
</section>


           </div>
          </div>
          

<footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="windows_performance.html" class="btn btn-neutral float-left" title="Windows performance" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="windows_usage.html" class="btn btn-neutral float-right" title="Using Ansible and Windows" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Ansible project contributors.
      <span class="lastupdated">Last updated on Sep 20, 2024.
      </span></p>
  </div>

  
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script><!-- extra footer elements for Ansible beyond RTD Sphinx Theme -->
<!-- begin analytics -->
<script>
var _hsq = _hsq || [];
_hsq.push(["setContentType", "standard-page"]);
      (function(d,s,i,r) {
      if (d.getElementById(i)){return;}
      var n = d.createElement(s),e = document.getElementsByTagName(s)[0];
      n.id=i;n.src = 'https://js.hs-analytics.net/analytics/'+(Math.ceil(new Date()/r)*r)+'/330046.js';
      e.parentNode.insertBefore(n, e);
      })(document, "script", "hs-analytics",300000);
</script>
<!-- end analytics -->
<script>
if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
  _satellite.pageBottom();
}
</script>

</body>
</html>